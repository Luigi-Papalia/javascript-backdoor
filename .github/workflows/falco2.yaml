on:
  workflow_dispatch:

name: Falco Detection Final

permissions:
  packages: write
  contents: read
  actions: read

jobs:
  test-falco:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Do Everything
      run: |     
        # echo ${{ github.workspace }}
        docker run -d \
          --name falco \
          --privileged \
          -v /tmp:/tmp \
          -v /var/run/docker.sock:/host/var/run/docker.sock \
          -v /proc:/host/proc:ro \
          -v /etc:/host/etc:ro \
          -v ${{ github.workspace }}:/javascript:rw \
          -v ${{ github.workspace }}/falco_rules/custom_rules.yaml:/etc/falco/rules.d/custom_rules.yaml \
          falcosecurity/falco:latest falco -o "json_output=true" -o "file_output.enabled=true" -o "file_output.keep_alive=false" -o "file_output.filename=/tmp/falco_events.json" -o "engine.kind=modern_ebpf" -o base_syscalls.all=true

        for i in {1..30}; do
          if docker ps --filter "name=falco" --filter "status=running" | grep -q falco; then
            echo "Falco is running!!!!!!!!!"
            break
          fi
          echo "Waiting...."
          sleep 1
        done
        
        docker logs falco > a.txt
        cat a.txt
        # cat ${{ github.workspace }}/falco_rules/custom_rules.yaml
